# N.B. The tokens GH_TOKEN and GITHUBTOKEN are set in the Travis setup panel
# not encrypted into this file.

language: java

jdk:
- openjdk8

services:
- docker

env:
  global:
  - CLASSPATH=/usr/share/java/xalan-j2.jar:/usr/share/java/xercesImpl.jar:/usr/share/java/xml-resolver.jar:/build/.travis
  matrix:
  - BUILD_IMG=ubuntu:16.04 DEPS=openjdk-8-jdk JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/
  - BUILD_IMG=ubuntu:18.04 DEPS=openjdk-8-jdk JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/
  - BUILD_IMG=ubuntu:19.10 DEPS=openjdk-13-jdk JAVA_HOME=/usr/lib/jvm/java-13-openjdk-amd64/
  - BUILD_IMG=ubuntu:20.04 DEPS=openjdk-14-jdk JAVA_HOME=/usr/lib/jvm/java-14-openjdk-amd64/

script: docker run --rm=true -v $(pwd):/build:rw --env CLASSPATH=$CLASSPATH --env JAVA_HOME=$JAVA_HOME $BUILD_IMG /bin/sh -c "apt-get update && env DEBIAN_FRONTEND=noninteractive apt-get install --yes build-essential ant xsltproc libxml-xpath-perl libxml2-utils libsaxon-java libxml-commons-resolver1.1-java libsaxon-java libxerces2-java trang imagemagick dblatex w3m $DEPS && cd /build && cp .travis/xmlc ~/.xmlc && env JAVA_HOME=$JAVA_HOME make && env JAVA_HOME=$JAVA_HOME make check && env JAVA_HOME=$JAVA_HOME make dist" && export VERSION=$(make version)

after_success:
- |
  if [ "$TRAVIS_REPO_SLUG" = "docbook/xslt10-stylesheets" -a \
       "$TRAVIS_PULL_REQUEST" = "false" ]; then
    export GH_TOKEN
    .travis/publish-release.sh
  fi

notifications:
  email:
    on_success: change
    on_failure: change
  irc:
    channels:
    - chat.freenode.net#docbook

deploy:
  provider: releases
  api_key:
    secure: f4w3jrlDESAlhSZIGzBLMbL5OVdQu+zG1SPmXHYN5GUacrV+WnxuhiuVsbkxKMasltIGVijeWWBnVMD8k8HF3YgWQad80TLgBTpUnWeQK5mrJ4SkdpVryjeS31ZU7sk7DaT4AdyaTvgunINTNO2XH2mp1J6Ou20f9z3up+7uy1PLQHb9WU4OojqzASmcH48dklDX4bjDejc7GgXV3EKydZsx7fCEBp6KpDZ+dkYheB1byBAEJ3DXpY3gTU0yt6oS8g8PXSmoTtqY6eWCv0UffWLGphqHAH/VEsZmQhlP+y7H8QFKXiPxFW6IsjigeJ4lBSpJ5oDoJVY5v1XhR7Oe8IHMVprvGl3OQbOO1tDp93fYKGqloF+p5V7AYY89Fg7JmWVTduLInShFRhXjt2TzjNdbo0VHVpKRnr01zDHWuOXcGgsMLO/K1jdyMWnYFoJd5OEhEMOqA7Q8hpi8YGmR3hZTanCiDGkpMpKqQG7quGSqidJBjC/wdo8mqNl2wNy7VyqVCOYUwnB9s5s6JjWykOEa5TX/oQ9kbWNLUf18Z9sfTkQwAJhuE1CmVbk6gosmo3ZlqBpLiuSYVLZC98fgRwv6p22Vy8SpH7Q6tVaTG3UoVaX+DggJYUXADWh7/eDvGYXw0OCE78SSktry/wfENUlKqnLEbzvcQAgqnl3sUro=
  file:
  - dist/docbook-xsl-$VERSION.zip
  - dist/docbook-xsl-nons-$VERSION.zip
  - dist/docbook-xsl-doc-$VERSION.zip
  skip_cleanup: true
  on:
    tags: true
    all_branches: true
